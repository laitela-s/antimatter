<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°•í™” ì‹œë®¬ë ˆì´í„° (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Pretendard', 'Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Mobile-friendly scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        /* Hide number input spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Tap highlight removal for mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 font-sans min-h-screen pb-10">

    <div class="max-w-3xl mx-auto px-4 pt-6">
        <!-- Hero Header -->
        <header class="mb-6 text-center">
            <h1
                class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent mb-1">
                ê°•í™” ì‹œë®¬ë ˆì´í„° Pro
            </h1>
            <p class="text-xs text-slate-400">
                <span class="text-red-400 font-medium">âš ï¸ ì£¼ì˜:</span> 5ê°• ì´ìƒ, ì˜µì…˜ì´ ë¶€ì—¬ëœ ì¥ë¹„ ì „ìš©
            </p>
        </header>

        <!-- Input Section (Accordion Style for Mobile) -->
        <div class="space-y-4 mb-8">

            <!-- 1. Equipment Info -->
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700/50">
                <div class="px-5 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-purple-300 flex items-center gap-2">
                        <span>ï¿½ï¸</span> ì¥ë¹„ ê¸°ë³¸ ì •ë³´
                    </h2>
                </div>
                <div class="p-5 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">í˜„ì¬ ë‹¨ê³„</label>
                        <select id="enhance_level"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none transition appearance-none">
                            <option value="" disabled selected>ì„ íƒ</option>
                            <option value="5">5ê°•</option>
                            <option value="6">6ê°•</option>
                            <option value="7">7ê°•</option>
                            <option value="8">8ê°•</option>
                            <option value="9">9ê°•</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">ë‚´êµ¬ë„</label>
                        <input id="durability" type="number"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none transition"
                            placeholder="ì…ë ¥">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">ë ™ì œ</label>
                        <input id="equip" type="number"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none transition"
                            placeholder="ì˜ˆ: 70">
                        <p class="text-[9px] text-slate-500 mt-1">ê°•í™” ë¹„ìš© ê³„ì‚°ì— í•„ìš”</p>
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">íŠ¼íŠ¼í•œ ì¥ë¹„</label>
                        <select id="dur_flag"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none transition appearance-none">
                            <option value="" disabled selected>ì„ íƒ</option>
                            <option value="o">ì˜ˆ (O)</option>
                            <option value="x">ì•„ë‹ˆì˜¤ (X)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 2. Material Costs -->
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700/50">
                <div class="px-5 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-green-300 flex items-center gap-2">
                        <span>ğŸ’</span> ì¬ë£Œ ë¹„ìš©
                    </h2>
                </div>
                <div class="p-5 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">ê°•í™”ì„ ëŒ€ë© (ì–µ)</label>
                        <input id="stone_bulk" type="number" step="0.1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-green-500 outline-none transition"
                            placeholder="ë¹„ìš©">
                        <p class="text-[9px] text-slate-500 mt-1">ê°•í™” ì¬ë£Œë¹„ ê³„ì‚°ìš©</p>
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">ê°•ë ˆ (ë§Œ/ë ˆì•Œ)</label>
                        <input id="rea" type="number" step="1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-green-500 outline-none transition"
                            placeholder="ë‹¨ê°€">
                        <p class="text-[9px] text-slate-500 mt-1">ë³´í˜¸ì œ ë¹„ìš© ê³„ì‚°ìš©</p>
                    </div>
                </div>
            </div>

            <!-- 3. Sale Prices -->
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700/50">
                <div class="px-5 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-blue-300 flex items-center gap-2">
                        <span>ï¿½</span> ë‹¨ê³„ë³„ íŒë§¤ ê°€ê²©
                    </h2>
                </div>
                <div class="p-5 grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <p class="text-[10px] text-slate-400 mb-3">ìµœì¢… ê²°ê³¼ë¬¼ì˜ íŒë§¤ ê°€ê²© (ê¸°ëŒ€ê°€ì¹˜ ì‚°ì¶œìš©)</p>
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">7ê°• ê°€ê²© (ì–µ)</label>
                        <input id="sale7" type="number" step="0.1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition"
                            placeholder="7ê°•">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">8ê°• ê°€ê²© (ì–µ)</label>
                        <input id="sale8" type="number" step="0.1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition"
                            placeholder="8ê°•">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">9ê°• ê°€ê²© (ì–µ)</label>
                        <input id="sale9" type="number" step="0.1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition"
                            placeholder="9ê°•">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">10ê°• ê°€ê²© (ì–µ)</label>
                        <input id="sale10" type="number" step="0.1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition"
                            placeholder="10ê°•">
                    </div>
                </div>
            </div>

            <!-- 4. Current Market Price (Optional) -->
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700/50">
                <div class="px-5 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-yellow-300 flex items-center gap-2">
                        <span>ğŸ“Š</span> í˜„ì¬ ì¥ë¹„ ì‹œì„¸ (ì„ íƒ)
                    </h2>
                </div>
                <div class="p-5">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase tracking-wider">í˜„ì¬ ì¥ë¹„ ì‹œì„¸
                            (ì–µ)</label>
                        <input id="market_price" type="number" step="0.1"
                            class="text-white w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent outline-none transition"
                            placeholder="ì„ íƒ ì…ë ¥">
                        <p class="text-[9px] text-slate-500 mt-2">ê°•í™” ì‹œ ê°€ì¹˜ì™€ ë¹„êµìš© (ROI ê³„ì‚°)<br>
                            <span class="text-yellow-500">â€» í•„ìˆ˜ ì…ë ¥ì‚¬í•­ì´ ì•„ë‹™ë‹ˆë‹¤</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="px-2">
                <div class="flex items-center justify-between text-xs text-slate-400 mb-1">
                    <span>ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜</span>
                    <span id="trials-label" class="text-slate-300 font-mono">200,000</span>
                </div>
                <p class="text-[9px] text-slate-500 mb-2">ìˆ«ìê°€ í´ìˆ˜ë¡ ë” ì •í™•í•´ì§€ì§€ë§Œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤</p>
                <input id="trials" type="range" min="100000" max="1000000" step="10000" value="200000"
                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                    oninput="document.getElementById('trials-label').innerText = parseInt(this.value).toLocaleString()">
            </div>

            <button onclick="calculate()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 active:scale-[0.98] text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-indigo-500/20 transition-all duration-200 flex justify-center items-center gap-2 text-base">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                ë¶„ì„ ì‹œì‘
            </button>
        </div>

        <!-- Result Section -->
        <div id="result-container" class="hidden animate-fade-in-up">
            <div class="bg-slate-800 rounded-xl p-5 shadow-xl border border-slate-700 relative overflow-hidden">
                <!-- Top Disclaimer -->
                <div
                    class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 mb-5 text-[11px] text-blue-200 flex gap-2 items-start leading-snug">
                    <svg class="w-4 h-4 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ íŠ¹ì„±ìƒ ë§¤ ê³„ì‚°ë§ˆë‹¤ ê²°ê³¼ì— ë¯¸ì„¸í•œ í¸ì°¨ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë” ì •í™•í•œ ê°’ì€ ì‹œí–‰ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <!-- ROI Badge -->
                <div id="roi-badge" class="hidden absolute top-0 right-0 m-5">
                    <!-- JS will inject badge here -->
                </div>

                <h2 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                    ğŸ“Š ë¶„ì„ ê²°ê³¼
                </h2>

                <div id="result-content" class="space-y-6">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50" style="display: none;">
            <div class="h-full flex flex-col items-center justify-center">
                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4">
                </div>
                <p class="text-blue-400 font-medium animate-pulse">ì‹œë®¬ë ˆì´ì…˜ ë¶„ì„ ì¤‘...</p>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script>
        const SR = [1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.1];
        const SRD = [1.0, 0.92, 0.83, 0.75, 0.67, 0.58, 0.50, 0.42, 0.33, 0.25];
        const SC = [1, 2, 3, 5, 10, 20, 30, 50, 100, 200];
        const PC = [1, 2, 3, 4, 8, 10, 15, 20, 30, 50];

        function gold_cost(equip, cur) {
            if (equip <= 69) {
                base = Math.round(10 * (equip ** 2.5) / 10) * 10;
            } else {
                if (equip === 70)
                    base = 958000;
                else if (equip >= 71 && equip <= 79)
                    base = 2000000;
                else if (equip === 80)
                    base = 3303400;
                else if (equip === 90)
                    base = 7290000;
                else
                    base = Math.round(10 * (equip ** 2.5) / 10) * 10;
            }
            return base * (2 ** cur);
        }

        function sim_trial_dual_stats(lvl, dur, th12, th11, th10, th9,
            equip, use_dur, stone_unit, pot_factor, sale) {
            let total_cost = 0;
            let cl = lvl;
            let cd = dur;

            while (cl < 10 && cd > cl) {
                let use_prot = false;
                if (cd >= 10) use_prot = (cl >= th10);
                else if (cd === 9) use_prot = (cl >= th9);

                let base = use_dur ? SRD[cl] : SR[cl];
                let eff = use_prot ? Math.min(base + 0.2, 1.0) : base;

                if (!use_prot) {
                    total_cost += gold_cost(equip, cl) + SC[cl] * stone_unit;
                } else {
                    total_cost += PC[cl] * pot_factor;
                }

                if (Math.random() < eff) {
                    cl++;
                } else {
                    if (use_prot) {
                        cd--;
                    } else {
                        if (Math.random() < (cl / 10.0)) {
                            return { finalLevel: 0, cost: total_cost };
                        } else {
                            cd--;
                        }
                    }
                }
            }
            return { finalLevel: cl, cost: total_cost };
        }

        function sim_price_dual(n, lvl, dur, th10, th9, equip, use_dur, stone_unit, pot_factor, sale) {
            let s = 0;
            for (let i = 0; i < n; i++) {
                let res = sim_trial_dual_stats(lvl, dur, 100, 100, th10, th9, equip, use_dur, stone_unit, pot_factor, sale);
                let val = (res.finalLevel >= 7) ? ((sale[res.finalLevel] || 0) - res.cost) : -res.cost;
                s += val;
            }
            return s / n;
        }

        function sim_stats_dual(n, lvl, dur, th10, th9, equip, use_dur, stone_unit, pot_factor) {
            let counts = { 10: 0, 9: 0, 8: 0, 7: 0, 0: 0 };

            for (let i = 0; i < n; i++) {
                let res = sim_trial_dual_stats(lvl, dur, 100, 100, th10, th9, equip, use_dur, stone_unit, pot_factor, {});
                if (res.finalLevel >= 7) {
                    counts[res.finalLevel] = (counts[res.finalLevel] || 0) + 1;
                } else {
                    counts[0]++;
                }
            }
            return {
                10: (counts[10] / n) * 100,
                9: (counts[9] / n) * 100,
                8: (counts[8] / n) * 100,
                7: (counts[7] / n) * 100
            };
        }

        function format_gold(x, unit = true) {
            let absX = Math.abs(x);
            let sign = x < 0 ? "-" : "";

            absX = Math.round(absX / 1000) * 1000;
            let oku = Math.floor(absX / 100000000);
            let rem = absX % 100000000;
            let man = Math.floor(rem / 10000);

            let parts = [];
            if (oku) parts.push(oku + (unit ? "ì–µ" : ""));
            if (man) parts.push(man + (unit ? "ë§Œ" : ""));

            if (parts.length === 0) return "0";
            return sign + parts.join(" ");
        }

        function saveInputs() {
            const inputs = {
                market_price: document.getElementById("market_price").value,
                sale7: document.getElementById("sale7").value,
                sale8: document.getElementById("sale8").value,
                sale9: document.getElementById("sale9").value,
                sale10: document.getElementById("sale10").value,
                enhance_level: document.getElementById("enhance_level").value,
                durability: document.getElementById("durability").value,
                stone_bulk: document.getElementById("stone_bulk").value,
                rea: document.getElementById("rea").value,
                equip: document.getElementById("equip").value,
                dur_flag: document.getElementById("dur_flag").value,
                trials: document.getElementById("trials").value
            };
            localStorage.setItem("enhancerInputsPro", JSON.stringify(inputs));
        }

        function loadInputs() {
            const inputs = JSON.parse(localStorage.getItem("enhancerInputsPro"));
            if (inputs) {
                document.getElementById("market_price").value = inputs.market_price || "";
                document.getElementById("sale7").value = inputs.sale7 || "";
                document.getElementById("sale8").value = inputs.sale8 || "";
                document.getElementById("sale9").value = inputs.sale9 || "";
                document.getElementById("sale10").value = inputs.sale10 || "";
                document.getElementById("enhance_level").value = inputs.enhance_level || "";
                document.getElementById("durability").value = inputs.durability || "";
                document.getElementById("stone_bulk").value = inputs.stone_bulk || "";
                document.getElementById("rea").value = inputs.rea || "";
                document.getElementById("equip").value = inputs.equip || "";
                document.getElementById("dur_flag").value = inputs.dur_flag || "";
                document.getElementById("trials").value = inputs.trials || "200000";
            }
        }

        document.addEventListener("DOMContentLoaded", loadInputs);
        document.querySelectorAll("input, select").forEach(el => el.addEventListener("input", saveInputs));

        function calculate() {
            saveInputs();
            document.getElementById("loading").style.display = "block";
            document.getElementById("result-container").classList.add("hidden");

            setTimeout(() => {
                const marketPrice = parseFloat(document.getElementById("market_price").value) * 1e8 || 0;
                const sale7 = parseFloat(document.getElementById("sale7").value) * 1e8 || 0;
                const sale8 = parseFloat(document.getElementById("sale8").value) * 1e8 || 0;
                const sale9 = parseFloat(document.getElementById("sale9").value) * 1e8 || 0;
                const sale10 = parseFloat(document.getElementById("sale10").value) * 1e8 || 0;
                const stoneBulk = parseFloat(document.getElementById("stone_bulk").value) * 1e8 || 0;
                const rea = parseFloat(document.getElementById("rea").value) * 1e4 || 0;
                const equip = parseFloat(document.getElementById("equip").value) || 0;
                const durStr = document.getElementById("dur_flag").value?.trim().toLowerCase();
                const trials = parseInt(document.getElementById("trials").value) || 200000;

                let sale = { 7: sale7, 8: sale8, 9: sale9, 10: sale10 };
                let cur_lvl = parseInt(document.getElementById("enhance_level").value);
                let init_dur = parseInt(document.getElementById("durability").value);

                if (isNaN(cur_lvl) || cur_lvl < 5 || isNaN(init_dur) || !durStr) {
                    alert("ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    document.getElementById("loading").style.display = "none";
                    return;
                }

                let stone_unit = stoneBulk / 400.0;
                let pot_factor = 10 * rea;
                let use_dur = (durStr === 'o');

                let finalExpectedValue = 0;
                let bestStrategyText = "";
                let chosenTh10 = 100;
                let chosenTh9 = 100;

                if (init_dur <= 8) {
                    finalExpectedValue = sim_price_dual(trials, cur_lvl, init_dur, 100, 100, equip, use_dur, stone_unit, pot_factor, sale);
                    bestStrategyText = `
                        <div class="text-sm text-slate-300">í˜„ì¬ ë‚´êµ¬ë„ê°€ ë‚®ì•„(<span class="text-red-400 font-bold">${init_dur}</span>) ë³´í˜¸ì œ íš¨ìœ¨ì´ ë‚®ìŠµë‹ˆë‹¤.</div>
                        <div class="text-lg font-bold text-white mt-1">ê¹¡ê°•í™”(ë³´í˜¸ì œ ë¯¸ì‚¬ìš©) ì¶”ì²œ</div>
                    `;
                } else {
                    let params = { 10: { ub: [10, 9], idx: [0, 1] }, 9: { ub: [9], idx: [1] } };
                    let setting = params[Math.min(init_dur, 10)];

                    let defs = [100, 100];
                    let best = -1e99;

                    for (let i = 0; i < setting.ub.length; i++) {
                        let ub = setting.ub[i];
                        let idx = setting.idx[i];

                        let localBest = -1e99;
                        let localCand = null;

                        for (let cand = cur_lvl; cand < ub; cand++) {
                            defs[idx] = cand;
                            let exp = sim_price_dual(trials, cur_lvl, init_dur, defs[0], defs[1], equip, use_dur, stone_unit, pot_factor, sale);
                            if (exp > localBest) { localBest = exp; localCand = cand; }
                        }

                        let exp_no = sim_price_dual(trials, cur_lvl, init_dur, ...defs.slice(0, idx), 100, ...defs.slice(idx + 1), equip, use_dur, stone_unit, pot_factor, sale);
                        if (exp_no > localBest) { localBest = exp_no; localCand = "ë¯¸ì‚¬ìš©"; }

                        defs[idx] = (localCand === "ë¯¸ì‚¬ìš©") ? 100 : localCand;
                    }

                    finalExpectedValue = sim_price_dual(trials, cur_lvl, init_dur, defs[0], defs[1], equip, use_dur, stone_unit, pot_factor, sale);
                    chosenTh10 = defs[0];
                    chosenTh9 = defs[1];

                    let strategySteps = [];
                    if (init_dur >= 10) {
                        strategySteps.push(chosenTh10 === 100
                            ? `<span class="text-slate-400">ë‚´êµ¬ 10 ì´ìƒ:</span> <strong>ë¯¸ì‚¬ìš©</strong>`
                            : `<span class="text-slate-400">ë‚´êµ¬ 10 ì´ìƒ:</span> <strong class="text-blue-400">${chosenTh10}ê°•</strong>ë¶€í„° ë³´í˜¸ì œ`);
                    }
                    strategySteps.push(chosenTh9 === 100
                        ? `<span class="text-slate-400">ë‚´êµ¬ 9:</span> <strong>ë¯¸ì‚¬ìš©</strong>`
                        : `<span class="text-slate-400">ë‚´êµ¬ 9 ë„ë‹¬ì‹œ:</span> <strong class="text-blue-400">${chosenTh9}ê°•</strong>ë¶€í„° ë³´í˜¸ì œ`);

                    bestStrategyText = `
                        <div class="space-y-1 text-sm bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                            ${strategySteps.map(s => `<div>${s}</div>`).join('')}
                        </div>
                    `;
                }

                let probs = sim_stats_dual(trials, cur_lvl, init_dur, chosenTh10, chosenTh9, equip, use_dur, stone_unit, pot_factor);

                let roiBadgeHtml = "";
                if (marketPrice > 0) {
                    let gainOverSellNow = finalExpectedValue - marketPrice;
                    let isGain = gainOverSellNow > 0;
                    let percent = (Math.abs(gainOverSellNow) / marketPrice) * 100;

                    roiBadgeHtml = `
                        <div class="px-3 py-1 rounded-full text-xs font-bold border ${isGain ? 'bg-green-500/20 text-green-400 border-green-500/50' : 'bg-red-500/20 text-red-400 border-red-500/50'}">
                            ${isGain ? 'â–² ì´ë“' : 'â–¼ ì†í•´'} ${percent.toFixed(1)}%
                        </div>
                     `;
                }

                const resultContent = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-indigo-900/20 p-4 rounded-xl border border-indigo-500/30">
                            <div class="text-xs text-indigo-300 mb-1 uppercase tracking-wide">ê¶Œì¥ ì „ëµ</div>
                            ${bestStrategyText}
                            
                            <div class="mt-4 pt-4 border-t border-indigo-500/30">
                                <div class="text-xs text-slate-400">ì¥ë¹„ ìµœì¢… ê¸°ëŒ€ìˆ˜ìµ</div>
                                <div class="text-2xl font-bold text-yellow-400">${format_gold(finalExpectedValue)}</div>
                                <div class="text-[10px] text-slate-500 mt-1">* ì¬ë£Œë¹„/ë³µêµ¬ë¹„ ì œì™¸ ìˆœìˆ˜ìµ</div>
                            </div>
                        </div>

                        <div class="space-y-3">
                             <div class="text-xs text-slate-400 uppercase tracking-wide mb-2">ìµœì¢… ë„ë‹¬ í™•ë¥ </div>
                             ${[10, 9, 8, 7].map(lv => {
                    let p = probs[lv];
                    let color = lv === 10 ? 'bg-red-500' : lv === 9 ? 'bg-orange-500' : lv === 8 ? 'bg-yellow-500' : 'bg-green-500';
                    return `
                                    <div class="relative pt-1">
                                        <div class="flex items-center justify-between text-xs mb-1">
                                            <span class="font-bold text-slate-300">${lv}ê°• ì™„ì„±</span>
                                            <span class="text-slate-400">${p.toFixed(2)}%</span>
                                        </div>
                                        <div class="overflow-hidden h-2 mb-2 text-xs flex rounded bg-slate-700">
                                            <div style="width:${p}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center ${color}"></div>
                                        </div>
                                    </div>
                                 `;
                }).join('')}
                             <div class="text-[10px] text-slate-500 text-right">ë‚˜ë¨¸ì§€ ${Math.max(0, 100 - (probs[10] + probs[9] + probs[8] + probs[7])).toFixed(2)}%ëŠ” íŒŒê´´</div>
                        </div>
                    </div>
                `;

                document.getElementById("roi-badge").innerHTML = roiBadgeHtml;
                document.getElementById("roi-badge").classList.remove("hidden");
                document.getElementById("result-content").innerHTML = resultContent;
                document.getElementById("result-container").classList.remove("hidden");
                document.getElementById("loading").style.display = "none";

                if (window.innerWidth < 768) {
                    document.getElementById("result-container").scrollIntoView({ behavior: 'smooth' });
                }

            }, 500);
        }
    </script>
</body>

</html>
